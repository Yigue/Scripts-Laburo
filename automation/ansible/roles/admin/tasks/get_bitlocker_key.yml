---
# ============================================================================
# Role: admin - Task: get_bitlocker_key
# Obtener clave de recuperaci√≥n BitLocker desde Active Directory
# ============================================================================
# NOTA: Requiere permisos para leer atributo msFVE-RecoveryPassword en AD
# Las claves se almacenan como objetos child del objeto computer
# ============================================================================

- name: Obtener clave de recuperaci√≥n BitLocker desde AD
  ansible.windows.win_shell: |
    try {
      Import-Module ActiveDirectory -ErrorAction Stop
      
      # Buscar el equipo en AD
      $computer = Get-ADComputer -Identity "{{ target_host }}" -ErrorAction Stop
      
      # Buscar objetos de recuperaci√≥n BitLocker asociados al equipo
      $bitlockerObjects = Get-ADObject -Filter 'objectClass -eq "msFVE-RecoveryInformation"' `
        -SearchBase $computer.DistinguishedName `
        -Properties msFVE-RecoveryPassword, msFVE-RecoveryGuid, whenCreated `
        -ErrorAction SilentlyContinue
      
      if ($bitlockerObjects) {
        $keys = @()
        foreach ($obj in $bitlockerObjects) {
          $keys += @{
            recoveryPassword = $obj.'msFVE-RecoveryPassword'
            recoveryGuid = $obj.'msFVE-RecoveryGuid'
            createdDate = $obj.whenCreated.ToString("dd/MM/yyyy HH:mm:ss")
          }
        }
        
        @{
          found = $true
          computerName = $computer.Name
          keysCount = $keys.Count
          keys = $keys
        } | ConvertTo-Json -Depth 3
      } else {
        @{
          found = $false
          computerName = $computer.Name
          error = "No se encontraron claves de recuperaci√≥n BitLocker en AD"
        } | ConvertTo-Json
      }
    } catch [Microsoft.ActiveDirectory.Management.ADIdentityNotFoundException] {
      @{ found = $false; error = "Equipo '{{ target_host }}' no encontrado en AD" } | ConvertTo-Json
    } catch {
      @{ found = $false; error = $_.Exception.Message } | ConvertTo-Json
    }
  register: bitlocker_result_raw
  changed_when: false
  delegate_to: "{{ domain_controller | default(inventory_hostname) }}"

- name: Parsear resultado BitLocker
  set_fact:
    bitlocker_result: "{{ bitlocker_result_raw.stdout | from_json }}"

- name: Mostrar claves de recuperaci√≥n BitLocker
  debug:
    msg:
      - "=========================================="
      - "  BITLOCKER - CLAVES DE RECUPERACI√ìN (AD)"
      - "=========================================="
      - "Equipo: {{ bitlocker_result.computerName | default(target_host) }}"
      - "Claves encontradas: {{ bitlocker_result.keysCount | default(0) }}"
      - "=========================================="
  when: bitlocker_result.found | default(false)

- name: Mostrar cada clave de recuperaci√≥n
  debug:
    msg:
      - "---"
      - "üîë Recovery Password: {{ item.recoveryPassword }}"
      - "   GUID: {{ item.recoveryGuid }}"
      - "   Fecha: {{ item.createdDate }}"
  loop: "{{ bitlocker_result.keys | default([]) }}"
  when: bitlocker_result.found | default(false)

- name: Mostrar error si no se encontraron claves
  debug:
    msg:
      - "=========================================="
      - "  BITLOCKER - SIN CLAVES ENCONTRADAS"
      - "=========================================="
      - "Equipo: {{ target_host }}"
      - "Error: {{ bitlocker_result.error | default('Desconocido') }}"
      - ""
      - "Posibles causas:"
      - "  ‚Ä¢ BitLocker no est√° habilitado en el equipo"
      - "  ‚Ä¢ Las claves no est√°n respaldadas en AD"
      - "  ‚Ä¢ Sin permisos para leer msFVE-RecoveryPassword"
      - "  ‚Ä¢ El equipo no est√° en el dominio"
  when: not (bitlocker_result.found | default(false))

- name: Alternativa: Obtener BitLocker directamente del equipo
  ansible.windows.win_shell: |
    try {
      $volumes = Get-BitLockerVolume -ErrorAction Stop
      
      $results = @()
      foreach ($vol in $volumes) {
        foreach ($protector in $vol.KeyProtector) {
          if ($protector.KeyProtectorType -eq "RecoveryPassword") {
            $results += @{
              volume = $vol.MountPoint
              recoveryPassword = $protector.RecoveryPassword
              protectorId = $protector.KeyProtectorId
            }
          }
        }
      }
      
      if ($results.Count -gt 0) {
        @{
          found = $true
          source = "Local"
          keys = $results
        } | ConvertTo-Json -Depth 3
      } else {
        @{ found = $false; error = "No hay protectores de recuperaci√≥n configurados" } | ConvertTo-Json
      }
    } catch {
      @{ found = $false; error = $_.Exception.Message } | ConvertTo-Json
    }
  register: bitlocker_local_raw
  when: not (bitlocker_result.found | default(false))
  ignore_errors: true

- name: Mostrar claves locales si est√°n disponibles
  debug:
    msg:
      - "=========================================="
      - "  BITLOCKER - CLAVES LOCALES"
      - "=========================================="
      - "{{ bitlocker_local_raw.stdout | default('No se pudieron obtener claves locales') }}"
  when: 
    - not (bitlocker_result.found | default(false))
    - bitlocker_local_raw is defined
    - bitlocker_local_raw.stdout is defined
