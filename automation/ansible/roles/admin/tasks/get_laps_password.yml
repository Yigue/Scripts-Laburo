---
# ============================================================================
# Role: admin - Task: get_laps_password
# Obtener contrase√±a de Administrador Local (LAPS) desde AD
# ============================================================================
# NOTA: Requiere permisos para leer atributo ms-Mcs-AdmPwd en AD
# La contrase√±a LAPS se almacena en el objeto computer del AD
# ============================================================================

- name: Obtener password LAPS del equipo
  ansible.windows.win_shell: |
    try {
      Import-Module ActiveDirectory -ErrorAction Stop
      
      # Buscar el equipo en AD
      $computer = Get-ADComputer -Identity "{{ target_host }}" -Properties ms-Mcs-AdmPwd, ms-Mcs-AdmPwdExpirationTime -ErrorAction Stop
      
      $lapsPassword = $computer.'ms-Mcs-AdmPwd'
      $expirationTime = $computer.'ms-Mcs-AdmPwdExpirationTime'
      
      if ($lapsPassword) {
        # Convertir el tiempo de expiraci√≥n si existe
        $expirationDate = "N/A"
        if ($expirationTime) {
          try {
            $expirationDate = [DateTime]::FromFileTime($expirationTime).ToString("dd/MM/yyyy HH:mm:ss")
          } catch { }
        }
        
        @{
          found = $true
          computerName = $computer.Name
          password = $lapsPassword
          expirationDate = $expirationDate
        } | ConvertTo-Json
      } else {
        @{
          found = $false
          computerName = $computer.Name
          error = "LAPS no configurado o sin permisos para leer la contrase√±a"
        } | ConvertTo-Json
      }
    } catch [Microsoft.ActiveDirectory.Management.ADIdentityNotFoundException] {
      @{ found = $false; error = "Equipo '{{ target_host }}' no encontrado en AD" } | ConvertTo-Json
    } catch {
      @{ found = $false; error = $_.Exception.Message } | ConvertTo-Json
    }
  register: laps_result_raw
  changed_when: false
  delegate_to: "{{ domain_controller | default(inventory_hostname) }}"

- name: Parsear resultado LAPS
  set_fact:
    laps_result: "{{ laps_result_raw.stdout | from_json }}"

- name: Mostrar contrase√±a LAPS
  debug:
    msg:
      - "=========================================="
      - "     LAPS - PASSWORD ADMIN LOCAL"
      - "=========================================="
      - "Equipo: {{ laps_result.computerName | default(target_host) }}"
      - ""
      - "{{ 'üîë Password: ' + laps_result.password if laps_result.found else '‚ùå ' + laps_result.error }}"
      - ""
      - "{{ 'Expira: ' + laps_result.expirationDate if laps_result.found else '' }}"
      - "=========================================="
      - "{{ 'NOTA: Guarde esta contrase√±a de forma segura' if laps_result.found else 'Verificar: Permisos en AD, LAPS habilitado en el equipo' }}"
  when: laps_result is defined

- name: Alternativa: Obtener LAPS con Get-LapsADPassword (Windows LAPS nativo)
  ansible.windows.win_shell: |
    try {
      # Intentar con cmdlet nativo de Windows LAPS (Windows Server 2019+)
      $lapsInfo = Get-LapsADPassword -Identity "{{ target_host }}" -AsPlainText -ErrorAction Stop
      
      @{
        found = $true
        computerName = $lapsInfo.ComputerName
        password = $lapsInfo.Password
        expirationDate = $lapsInfo.ExpirationTimestamp.ToString("dd/MM/yyyy HH:mm:ss")
        account = $lapsInfo.Account
      } | ConvertTo-Json
    } catch {
      @{ found = $false; error = "Get-LapsADPassword no disponible o sin permisos: $($_.Exception.Message)" } | ConvertTo-Json
    }
  register: laps_native_raw
  when: not (laps_result.found | default(false))
  ignore_errors: true
  delegate_to: "{{ domain_controller | default(inventory_hostname) }}"

- name: Mostrar resultado alternativo
  debug:
    msg: "{{ laps_native_raw.stdout | default('No se pudo obtener LAPS por m√©todo alternativo') }}"
  when: 
    - not (laps_result.found | default(false))
    - laps_native_raw is defined
    - laps_native_raw.stdout is defined
