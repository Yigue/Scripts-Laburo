---
# Playbook de Ansible para listar aplicaciones instaladas en Windows
# NOTA: Template para uso futuro con Ansible
# Para usar, necesitás:
# 1. Instalar Ansible: pip install ansible pywinrm
# 2. Configurar WinRM en los hosts remotos
# 3. Configurar inventory en automation/ansible/inventory/

- name: Listar aplicaciones instaladas en hosts Windows
  hosts: windows_hosts
  gather_facts: no
  
  tasks:
    - name: Obtener lista de aplicaciones instaladas desde Registry
      win_shell: |
        $apps = Get-ItemProperty HKLM:\Software\Microsoft\Windows\CurrentVersion\Uninstall\* | 
          Where-Object { $_.DisplayName -ne $null } | 
          Select-Object DisplayName, DisplayVersion, Publisher, InstallDate, EstimatedSize |
          Sort-Object DisplayName
        
        $apps | Format-Table -AutoSize
        Write-Host "`nTotal de aplicaciones: $($apps.Count)" -ForegroundColor Green
        
        # Exportar a JSON para procesamiento
        $apps | ConvertTo-Json -Depth 3 | Out-File -FilePath "$env:TEMP\apps_list.json" -Encoding UTF8
        Write-Host "`nLista exportada a: $env:TEMP\apps_list.json" -ForegroundColor Cyan
      register: apps_list
      
    - name: Mostrar resumen de aplicaciones
      debug:
        msg: "{{ apps_list.stdout_lines }}"
        
    - name: Obtener aplicaciones instaladas desde WMI (método alternativo)
      win_shell: |
        Get-WmiObject -Class Win32_Product | 
          Select-Object Name, Version, Vendor, InstallDate |
          Format-Table -AutoSize
      register: wmi_apps
      ignore_errors: yes
      
    - name: Buscar aplicaciones de Dell específicamente
      win_shell: |
        $dellApps = Get-ItemProperty HKLM:\Software\Microsoft\Windows\CurrentVersion\Uninstall\* | 
          Where-Object { 
            ($_.DisplayName -like "*Dell*") -or 
            ($_.Publisher -like "*Dell*") 
          } | 
          Select-Object DisplayName, DisplayVersion, Publisher, InstallDate |
          Sort-Object DisplayName
        
        if ($dellApps) {
          Write-Host "`n=== Aplicaciones de Dell ===" -ForegroundColor Yellow
          $dellApps | Format-Table -AutoSize
          Write-Host "Total: $($dellApps.Count)" -ForegroundColor Green
        } else {
          Write-Host "No se encontraron aplicaciones de Dell" -ForegroundColor Gray
        }
      register: dell_apps
      
    - name: Mostrar aplicaciones de Dell encontradas
      debug:
        msg: "{{ dell_apps.stdout_lines }}"

