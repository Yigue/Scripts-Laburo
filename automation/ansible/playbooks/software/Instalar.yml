---
# Playbook de Ansible para instalar software en Windows
# NOTA: Template para uso futuro con Ansible
# Para usar, necesitás:
# 1. Instalar Ansible: pip install ansible pywinrm
# 2. Configurar WinRM en los hosts remotos
# 3. Configurar inventory en automation/ansible/inventory/
# 4. Ajustar las variables según el software a instalar

- name: Instalar software en hosts Windows
  hosts: windows_hosts
  gather_facts: no
  
  vars:
    # Ruta al instalador (ajustar según necesidad)
    installer_path: "C:\\temp\\software.msi"
    # O usar URL para descargar
    installer_url: ""
    # Argumentos de instalación silenciosa
    install_args: "/quiet /norestart"
    # Nombre del software para verificación
    software_name: ""
  
  vars_prompt:
    - name: installer_path
      prompt: "Ruta completa al instalador (ej: C:\\temp\\app.msi o C:\\temp\\setup.exe)"
      default: "C:\\temp\\software.msi"
      private: no
    - name: software_name
      prompt: "Nombre del software para verificar instalación (ej: Microsoft Office)"
      default: ""
      private: no
    - name: install_args
      prompt: "Argumentos de instalación silenciosa (ej: /quiet /norestart)"
      default: "/quiet /norestart"
      private: no
  
  tasks:
    - name: Verificar si el instalador existe localmente
      win_stat:
        path: "{{ installer_path }}"
      register: installer_file
      
    - name: Descargar instalador desde URL (si se proporciona)
      win_get_url:
        url: "{{ installer_url }}"
        dest: "{{ installer_path }}"
      when: installer_url != "" and not installer_file.stat.exists
      
    - name: Verificar que el instalador existe antes de continuar
      fail:
        msg: "El instalador no existe en {{ installer_path }}"
      when: not installer_file.stat.exists and installer_url == ""
      
    - name: Verificar si el software ya está instalado
      win_shell: |
        $installed = Get-ItemProperty HKLM:\Software\Microsoft\Windows\CurrentVersion\Uninstall\* | 
          Where-Object { $_.DisplayName -like "*{{ software_name }}*" }
        
        if ($installed) {
          Write-Host "El software ya está instalado: $($installed.DisplayName)" -ForegroundColor Yellow
          exit 1
        } else {
          Write-Host "El software no está instalado, procediendo con la instalación..." -ForegroundColor Green
          exit 0
        }
      register: check_installed
      ignore_errors: yes
      when: software_name != ""
      
    - name: Detener procesos relacionados antes de instalar
      win_shell: |
        $processes = Get-Process | Where-Object { $_.ProcessName -like "*{{ software_name }}*" }
        if ($processes) {
          $processes | Stop-Process -Force -ErrorAction SilentlyContinue
          Start-Sleep -Seconds 2
          Write-Host "Procesos detenidos" -ForegroundColor Yellow
        }
      when: software_name != ""
      ignore_errors: yes
      
    - name: Instalar software desde MSI
      win_package:
        path: "{{ installer_path }}"
        state: present
        arguments: "{{ install_args }}"
      when: installer_path | regex_search('\.msi$')
      register: install_result
      
    - name: Instalar software desde EXE
      win_shell: |
        $process = Start-Process -FilePath "{{ installer_path }}" -ArgumentList "{{ install_args }}" -Wait -PassThru -NoNewWindow
        if ($process.ExitCode -eq 0 -or $process.ExitCode -eq 3010) {
          Write-Host "Instalación exitosa (ExitCode: $($process.ExitCode))" -ForegroundColor Green
          exit 0
        } else {
          Write-Host "Error en la instalación (ExitCode: $($process.ExitCode))" -ForegroundColor Red
          exit $process.ExitCode
        }
      when: installer_path | regex_search('\.exe$')
      register: install_result
      
    - name: Verificar instalación exitosa
      win_shell: |
        Start-Sleep -Seconds 5
        $installed = Get-ItemProperty HKLM:\Software\Microsoft\Windows\CurrentVersion\Uninstall\* | 
          Where-Object { $_.DisplayName -like "*{{ software_name }}*" }
        
        if ($installed) {
          Write-Host "✅ Verificación exitosa: $($installed.DisplayName) v$($installed.DisplayVersion)" -ForegroundColor Green
          exit 0
        } else {
          Write-Host "⚠️ No se pudo verificar la instalación" -ForegroundColor Yellow
          exit 1
        }
      when: software_name != ""
      register: verify_install
      ignore_errors: yes
      
    - name: Mostrar resultado de la instalación
      debug:
        msg: "{{ install_result }}"

