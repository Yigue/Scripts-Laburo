---
# Playbook de Ansible para desinstalar Dell Command | Update
# NOTA: Template para uso futuro con Ansible
# Para usar, necesitás:
# 1. Instalar Ansible: pip install ansible pywinrm
# 2. Configurar WinRM en los hosts remotos
# 3. Configurar inventory en automation/ansible/inventory/
# Este playbook desinstala específicamente Dell Command | Update y componentes relacionados

- name: Desinstalar Dell Command | Update en hosts Windows
  hosts: windows_hosts
  gather_facts: no
  
  tasks:
    - name: Buscar Dell Command | Update instalado
      win_shell: |
        $dellApps = Get-ItemProperty HKLM:\Software\Microsoft\Windows\CurrentVersion\Uninstall\* | 
          Where-Object { 
            ($_.DisplayName -like "*Dell Command*Update*") -or
            ($_.DisplayName -like "*Dell Command*") -or
            ($_.DisplayName -like "*Dell Update*") -or
            ($_.Publisher -like "*Dell*" -and $_.DisplayName -like "*Update*")
          } | 
          Select-Object DisplayName, DisplayVersion, Publisher, UninstallString, PSChildName, InstallDate
        
        if ($dellApps) {
          Write-Host "`n=== Aplicaciones de Dell Command encontradas ===" -ForegroundColor Cyan
          $dellApps | Format-Table -AutoSize
          $dellApps | ConvertTo-Json -Depth 3 | Out-File -FilePath "$env:TEMP\dell_command_apps.json" -Encoding UTF8
          Write-Host "Total encontradas: $($dellApps.Count)" -ForegroundColor Green
          exit 0
        } else {
          Write-Host "No se encontró Dell Command | Update instalado" -ForegroundColor Yellow
          exit 1
        }
      register: found_dell_command
      ignore_errors: yes
      
    - name: Mostrar aplicaciones de Dell Command encontradas
      debug:
        msg: "{{ found_dell_command.stdout_lines }}"
      when: found_dell_command.rc == 0
      
    - name: Detener servicios de Dell Command
      win_shell: |
        $services = @("DellClientManagementService", "DellUpdateService", "DellCommandUpdateService")
        foreach ($service in $services) {
          $svc = Get-Service -Name $service -ErrorAction SilentlyContinue
          if ($svc) {
            Write-Host "Deteniendo servicio: $service" -ForegroundColor Yellow
            Stop-Service -Name $service -Force -ErrorAction SilentlyContinue
          }
        }
        Start-Sleep -Seconds 2
      ignore_errors: yes
      
    - name: Detener procesos de Dell Command
      win_shell: |
        $processes = Get-Process | Where-Object { 
          $_.ProcessName -like "*Dell*" -or
          $_.ProcessName -like "*DCU*" -or
          $_.MainWindowTitle -like "*Dell Command*"
        }
        if ($processes) {
          Write-Host "Deteniendo procesos de Dell..." -ForegroundColor Yellow
          $processes | Stop-Process -Force -ErrorAction SilentlyContinue
          Start-Sleep -Seconds 3
        }
      ignore_errors: yes
      
    - name: Desinstalar Dell Command | Update
      win_shell: |
        $apps = Get-Content "$env:TEMP\dell_command_apps.json" | ConvertFrom-Json
        
        foreach ($app in $apps) {
          $displayName = $app.DisplayName
          $uninstallString = $app.UninstallString
          $productCode = $app.PSChildName
          
          Write-Host "`n=== Desinstalando: $displayName ===" -ForegroundColor Cyan
          
          # Método 1: Intentar con msiexec usando ProductCode
          if ($productCode -match '^{[A-F0-9-]+}$') {
            Write-Host "Intentando desinstalación con msiexec (ProductCode)..." -ForegroundColor Gray
            $msiArgs = "/x $productCode /quiet /norestart /L*v `"$env:TEMP\dell_uninstall_$productCode.log`""
            $process = Start-Process -FilePath "msiexec.exe" -ArgumentList $msiArgs -Wait -PassThru -NoNewWindow
            Start-Sleep -Seconds 5
            
            # Verificar si se desinstaló
            $stillInstalled = Get-ItemProperty HKLM:\Software\Microsoft\Windows\CurrentVersion\Uninstall\$productCode -ErrorAction SilentlyContinue
            if (-not $stillInstalled) {
              Write-Host "✅ $displayName desinstalado correctamente (método msiexec)" -ForegroundColor Green
              continue
            }
          }
          
          # Método 2: Usar UninstallString directamente
          if ($uninstallString) {
            Write-Host "Intentando desinstalación con UninstallString..." -ForegroundColor Gray
            
            # Limpiar y preparar el comando
            $cleanUninstall = $uninstallString -replace '"', ''
            
            if ($cleanUninstall -like "*msiexec*") {
              # Extraer GUID si está en el UninstallString
              if ($cleanUninstall -match '{[A-F0-9-]+}') {
                $guid = $matches[0]
                $msiArgs = "/x $guid /quiet /norestart"
                Write-Host "Ejecutando: msiexec $msiArgs" -ForegroundColor Gray
                $process = Start-Process -FilePath "msiexec.exe" -ArgumentList $msiArgs -Wait -PassThru -NoNewWindow
              }
            } 
            elseif ($cleanUninstall -like "*.exe*") {
              # Desinstalación con EXE
              $exePath = ($cleanUninstall -split '\.exe')[0] + '.exe'
              $existingArgs = ($cleanUninstall -split '\.exe')[1]
              
              # Agregar argumentos silenciosos comunes para Dell
              $args = if ($existingArgs) { 
                $existingArgs.Trim() + " /S /silent /quiet" 
              } else { 
                "/S /silent /quiet /uninstall" 
              }
              
              Write-Host "Ejecutando: $exePath $args" -ForegroundColor Gray
              if (Test-Path $exePath) {
                $process = Start-Process -FilePath $exePath -ArgumentList $args -Wait -PassThru -NoNewWindow
              } else {
                Write-Host "⚠️ No se encontró el ejecutable: $exePath" -ForegroundColor Yellow
              }
            }
            
            Start-Sleep -Seconds 5
          }
          
          # Verificar desinstalación final
          $finalCheck = Get-ItemProperty HKLM:\Software\Microsoft\Windows\CurrentVersion\Uninstall\* | 
            Where-Object { $_.DisplayName -eq $displayName }
          
          if (-not $finalCheck) {
            Write-Host "✅ $displayName desinstalado correctamente" -ForegroundColor Green
          } else {
            Write-Host "⚠️ $displayName aún está instalado (puede requerir reinicio o desinstalación manual)" -ForegroundColor Yellow
            Write-Host "   UninstallString: $uninstallString" -ForegroundColor Gray
            Write-Host "   ProductCode: $productCode" -ForegroundColor Gray
          }
        }
      when: found_dell_command.rc == 0
      register: uninstall_result
      
    - name: Limpiar archivos residuales de Dell Command
      win_shell: |
        $paths = @(
          "$env:ProgramFiles\Dell\CommandUpdate",
          "$env:ProgramFiles(x86)\Dell\CommandUpdate",
          "$env:ProgramData\Dell\CommandUpdate",
          "$env:LOCALAPPDATA\Dell\CommandUpdate"
        )
        
        foreach ($path in $paths) {
          if (Test-Path $path) {
            Write-Host "Eliminando: $path" -ForegroundColor Yellow
            Remove-Item -Path $path -Recurse -Force -ErrorAction SilentlyContinue
          }
        }
      ignore_errors: yes
      
    - name: Limpiar entradas del registro
      win_shell: |
        $regPaths = @(
          "HKLM:\Software\Dell\CommandUpdate",
          "HKLM:\Software\WOW6432Node\Dell\CommandUpdate"
        )
        
        foreach ($regPath in $regPaths) {
          if (Test-Path $regPath) {
            Write-Host "Eliminando entrada del registro: $regPath" -ForegroundColor Yellow
            Remove-Item -Path $regPath -Recurse -Force -ErrorAction SilentlyContinue
          }
        }
      ignore_errors: yes
      
    - name: Verificar desinstalación completa
      win_shell: |
        $stillInstalled = Get-ItemProperty HKLM:\Software\Microsoft\Windows\CurrentVersion\Uninstall\* | 
          Where-Object { 
            ($_.DisplayName -like "*Dell Command*Update*") -or
            ($_.DisplayName -like "*Dell Command*") -or
            ($_.DisplayName -like "*Dell Update*")
          }
        
        if ($stillInstalled) {
          Write-Host "`n⚠️ Aplicaciones de Dell Command aún instaladas:" -ForegroundColor Yellow
          $stillInstalled | Select-Object DisplayName, DisplayVersion | Format-Table -AutoSize
          exit 1
        } else {
          Write-Host "`n✅ Dell Command | Update desinstalado correctamente" -ForegroundColor Green
          exit 0
        }
      register: verify_uninstall
      ignore_errors: yes
      
    - name: Mostrar resultado final
      debug:
        msg: "{{ uninstall_result.stdout_lines if uninstall_result is defined else ['Dell Command | Update no estaba instalado'] }}"
